#!/bin/bash
# ==========================================================
# Auto-enable BBR2 if available, otherwise fall back to BBR,
# and set fq_codel as default qdisc.
# Ubuntu 20.04/22.04/24.04 (and similar) â€“ Kernel 4.9+ (BBR), 5.9+ (BBR2)
# ==========================================================

set -euo pipefail

log() { printf '%s\n' ">>> $*"; }
err() { printf '%s\n' "ERROR: $*" 1>&2; }

# --- prerequisites ---
if [ "${EUID:-$(id -u)}" -ne 0 ]; then
  err "Please run as root, e.g. sudo bash install"
  exit 1
fi

# Try to load modules if they exist (ignore failures; some builds are built-in)
modprobe tcp_bbr2 2>/dev/null || true
modprobe tcp_bbr  2>/dev/null || true
modprobe sch_fq_codel 2>/dev/null || true

# Read available congestion controls
AVAILABLE="$(sysctl -n net.ipv4.tcp_available_congestion_control 2>/dev/null || true)"
if [ -z "${AVAILABLE}" ]; then
  # Fallback read (rare)
  if [ -r /proc/sys/net/ipv4/tcp_available_congestion_control ]; then
    AVAILABLE="$(cat /proc/sys/net/ipv4/tcp_available_congestion_control)"
  fi
fi

if [ -z "${AVAILABLE}" ]; then
  err "Cannot detect available TCP congestion controls."
  exit 1
fi

log "Available congestion controls: ${AVAILABLE}"

TARGET_CC=""
case " ${AVAILABLE} " in
  *" bbr2 "*) TARGET_CC="bbr2" ;;
  *" bbr "*)  TARGET_CC="bbr"  ;;
  *)          TARGET_CC=""     ;;
esac

if [ -z "${TARGET_CC}" ]; then
  err "Neither bbr2 nor bbr is available on this kernel."
  err "Install a newer kernel (e.g., mainline/HWE) and re-run."
  exit 1
fi

log "Selecting congestion control: ${TARGET_CC}"

# --- runtime apply ---
log "Applying runtime sysctl..."
sysctl -w net.ipv4.tcp_congestion_control="${TARGET_CC}" >/dev/null
sysctl -w net.core.default_qdisc=fq_codel >/dev/null

# --- persist in /etc/sysctl.conf (idempotent) ---
log "Persisting settings to /etc/sysctl.conf ..."
# Remove existing lines for these keys (any duplicates)
sed -i -E '/^net\.ipv4\.tcp_congestion_control\s*=/d' /etc/sysctl.conf || true
sed -i -E '/^net\.core\.default_qdisc\s*=/d'        /etc/sysctl.conf || true

cat <<'EOF' >> /etc/sysctl.conf

# --- BBR/BBR2 + fq_codel (managed by installer) ---
net.ipv4.tcp_congestion_control=REPLACE_CC
net.core.default_qdisc=fq_codel
EOF

# Replace placeholder with selected CC
sed -i "s/^net\.ipv4\.tcp_congestion_control=REPLACE_CC/net.ipv4.tcp_congestion_control=${TARGET_CC}/" /etc/sysctl.conf

# Reload sysctl
sysctl -p >/dev/null || true

# --- verify ---
CUR_CC="$(sysctl -n net.ipv4.tcp_congestion_control 2>/dev/null || echo '?')"
CUR_QD="$(sysctl -n net.core.default_qdisc 2>/dev/null || echo '?')"

log "Current:"
printf '    net.ipv4.tcp_congestion_control = %s\n' "${CUR_CC}"
printf '    net.core.default_qdisc         = %s\n' "${CUR_QD}"

if [ "${CUR_CC}" = "${TARGET_CC}" ] && [ "${CUR_QD}" = "fq_codel" ]; then
  log "Completed successfully."
else
  err "Settings not applied as expected. Please check dmesg/sysctl."
  exit 1
fi
